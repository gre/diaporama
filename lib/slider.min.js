/*!
Copyright 2011 Gaetan Renaudeau
http://greweb.fr/slider

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
(function(){var d,f,e,l,a,k,i,j,c,g={}.hasOwnProperty,b=function(p,n){for(var m in n){if(g.call(n,m)){p[m]=n[m]}}function o(){this.constructor=p}o.prototype=n.prototype;p.prototype=new o();p.__super__=n.prototype;return p};k=function(n,m){return n-m*Math.floor(n/m)};i=function(n,m){while(n--&&!(m=window["oR0msR0mozR0webkitR0r".split(0)[n]+"equestAnimationFrame"])){}return m||function(o){setTimeout(o,15)}}(5);a=function(){return new Date().getTime()};j=function(n){var m;m=$('<div class="slider">\n  <div class="loader"><span class="spinner"></span> <span class="percent">0</span>%</div>\n  <div class="slide-images"></div>\n  <div class="options">\n    <a class="prevSlide" href="javascript:;">prev</a>\n    <span class="slide-pager"></span>\n    <a class="nextSlide" href="javascript:;">next</a>\n  </div>\n</div>');m.find(".slide-images").append($.map(n.slides,function(o){return $('<div class="slide-image">'+(o.link?'<a href="'+o.link+'" target="_blank">':"")+'<img src="'+o.src+'">'+(o.name?'<span class="caption">'+o.name+"</span>":"")+(o.link?"</a>":"")+"</div>")[0]}));m.find(".slide-pager").append($.map(n.slides,function(o,p){return $('<a href="javascript:;">'+(p+1)+"</a>")[0]}));return m};c=function(n){var m;m=j(n);m.find("div.slide-images").append('<canvas class="slide-images" />');return m};e={extractImageData:function(u,q,r){var s,t,n,p,m,o;o=u.canvas[0],m=o.width,t=o.height;u.clean();u.drawImage(u.images[q]);s=u.ctx.getImageData(0,0,m,t);u.clean();u.drawImage(u.images[r]);p=u.ctx.getImageData(0,0,m,t);n=u.ctx.createImageData(m,t);return{fromData:s,toData:p,output:n}},clippedTransition:function(m){return function(p,u,t,q){var o,n,r,s;s=p.canvas[0],r=s.width,n=s.height;o=p.ctx;p.drawImage(p.images[u]);o.save();o.beginPath();m(o,r,n,q);o.clip();p.drawImage(p.images[t]);return o.restore()}}};f={clock:{render:e.clippedTransition(function(n,m,o,q){n.moveTo(m/2,o/2);return n.arc(m/2,o/2,Math.max(m,o),0,Math.PI*2*q,false)})},circle:{render:e.clippedTransition(function(n,m,o,q){return n.arc(m/2,o/2,0.6*q*Math.max(m,o),0,Math.PI*2,false)})},diamond:{render:e.clippedTransition(function(o,n,s,u){var t,r,q,m;m=n/2;q=s/2;t=u*s;r=u*n;o.moveTo(m,q-t);o.lineTo(m+r,q);o.lineTo(m,q+t);return o.lineTo(m-r,q)})},verticalOpen:{render:e.clippedTransition(function(D,y,E,B){var v,u,s,C,A,t,r,m,F,z,x,q,n,o;C=8;t=E/(2*C);F=t;A=B*y/2;z=y/2-A;x=y/2+A;r=z-F;m=x+F;D.moveTo(z,0);for(s=q=0;0<=C?q<=C:q>=C;s=0<=C?++q:--q){v=(2*s)*t;u=v+t;D.lineTo(r,v);D.lineTo(z,u)}D.lineTo(m,E);o=[];for(s=n=C;C<=0?n<=0:n>=0;s=C<=0?++n:--n){v=(2*s)*t;u=v-t;D.lineTo(x,v);o.push(D.lineTo(m,u))}return o})},horizontalOpen:{render:e.clippedTransition(function(n,m,o,q){return n.rect(0,(1-q)*o/2,m,o*q)})},horizontalSunblind:{render:e.clippedTransition(function(v,u,r,m){var s,t,q,o,n;m=1-(1-m)*(1-m);q=6;t=r/q;n=[];for(s=o=0;0<=q?o<=q:o>=q;s=0<=q?++o:--o){n.push(v.rect(0,t*s,u,t*m))}return n})},verticalSunblind:{render:e.clippedTransition(function(x,v,s,m){var u,t,q,r,o,n;m=1-(1-m)*(1-m);q=10;t=v/q;n=[];for(u=o=0;0<=q?o<=q:o>=q;u=0<=q?++o:--o){r=Math.max(0,Math.min(2*m-(u+1)/q,1));n.push(x.rect(t*u,0,t*r,s))}return n})},circles:{render:e.clippedTransition(function(H,F,z,n){var v,E,B,A,s,o,u,G,m,D,C,t,q;A=6;B=Math.floor(A*F/z);E=F/B;v=z/A;G=Math.max(F,z);u=0.7*Math.max(E,v);q=[];for(D=t=0;0<=B?t<=B:t>=B;D=0<=B?++t:--t){q.push((function(){var r,p;p=[];for(C=r=0;0<=A?r<=A:r>=A;C=0<=A?++r:--r){s=(D+0.5)*E;o=(C+0.5)*v;m=Math.max(0,Math.min(2*n-s/F,1))*u;H.moveTo(s,o);p.push(H.arc(s,o,m,0,Math.PI*2,false))}return p})())}return q})},squares:{render:e.clippedTransition(function(G,F,u,m){var B,v,q,o,t,E,n,D,A,C,z,s,r;m=1-(1-m)*(1-m);o=5;q=Math.floor(o*F/u);v=F/q;B=u/o;r=[];for(C=s=0;0<=q?s<=q:s>=q;C=0<=q?++s:--s){r.push((function(){var x,p;p=[];for(z=x=0;0<=o?x<=o:x>=o;z=0<=o?++x:--x){D=v*C;A=B*z;t=Math.max(0,Math.min(3*m-D/F-A/u,1));n=v*t;E=B*t;p.push(G.rect(D-n/2,A-E/2,n,E))}return p})())}return r})},fadeLeft:{init:function(m,s,r){var p,n,q,o;p=e.extractImageData(m,s,r);p.randomTrait=[];n=m.canvas[0].height;for(q=o=0;0<=n?o<=n:o>=n;q=0<=n?++o:--o){p.randomTrait[q]=Math.random()}return p},render:function(z,v,x,m,t){var p,A,o,y,r,u,q,n,s;p=150;s=z.canvas[0],n=s.width,y=s.height;A=z.ctx;o=t.fromData.data;q=t.toData.data;r=t.output.data;u=t.randomTrait;(function(){var C=n*m/p;for(var H=0;H<n;++H){var B=H/p;for(var F=0;F<y;++F){var G=(F*n+H)*4;var J=Math.min(Math.max((B-C*(1+u[F]/10)),0),1);var I=1-J;for(var E=0;E<3;++E){var D=G+E;r[D]=J*(o[D])+I*(q[D])}r[G+3]=255}}}());return z.ctx.putImageData(t.output,0,0)}}};d=(function(){function m(n,o){var r,q,p;if(o==null){o={}}this.container=$(n);p=this.defaults;for(r in p){q=p[r];this[r]=r in o?ops[r]:q}this}m.prototype.defaults={current:0,duration:4000,width:"640px",height:"430px",theme:"theme-dark"};m.prototype.lastHumanNav=0;m.prototype.tmpl=j;m.prototype.circular=function(n){return k(n,this.slides.size())};m.prototype.slide=function(n){if(this.slides&&this.pages){n=Math.max(0,Math.min(n,this.slides.size()-1));this.slides.eq(this.current).removeClass("current");this.slides.eq(n).addClass("current");this.pages.eq(this.current).removeClass("current");this.pages.eq(n).addClass("current")}this.current=n;return this};m.prototype.next=function(){return this.slide(this.circular(this.current+1))};m.prototype.prev=function(){return this.slide(this.circular(this.current-1))};m.prototype.setDuration=function(n){this.duration=n;return this};m.prototype.setTransition=function(n){if(this.node){if(this.transition){this.node.removeClass(this.transition)}if(n){this.node.addClass(n)}}this.transition=n;return this};m.prototype.setTheme=function(n){if(n==null){n="theme-dark"}if(this.node){if(this.theme){this.node.removeClass(this.theme)}if(n){this.node.addClass(n)}}this.theme=n;return this};m.prototype.setSize=function(o,n){this.width=o;this.height=n;if(this.node){this.node.width(w);this.node.find(".slide-image").width(w);this.node.find(".slide-images").height(h)}return this};m.prototype.fetchJson=function(p,o,n){var q,r=this;q=$.extend({},o);if(n==null){n=function(s){return s}}$.getJSON(p,q,function(s){return r.setPhotos(n(s))});return this};m.prototype._sync=function(){this.setTransition(this.transition);this.setTheme(this.theme);this.setSize(this.width,this.height);return this.slide(this.current)};m.prototype.setPhotos=function(q){var p,n,o=this;this.photos=q;this.node=this.tmpl({slides:q}).addClass("loading");this.container.empty().append(this.node);this._sync();n=0;p=this.node.find(".slide-image img").bind("load",function(){var r;r=p.size();if(++n===r){o.node.removeClass("loading");o.start()}return o.node.find(".loader .percent").text(Math.floor(100*n/r))});if(p.size()===0){this.node.find(".loader").text("No photo")}return this};m.prototype.start=function(){this.slides=this.node.find(".slide-image");this.pages=this.node.find(".slide-pager a");this._sync();this._bind();return this};m.prototype.stop=function(){this._unbind();return this};m.prototype._bind=function(){var q,o,n,p=this;this._unbind();this.node.find(".prevSlide").click(function(){return p.prev()});this.node.find(".nextSlide").click(function(){return p.next()});n=this;if(this.node){this.node.find(".slide-pager a").each(function(r){return $(this).click(function(){return n.slide(r)})});o=function(){return a()};this.node.find(".options a").click(function(){return p.lastHumanNav=o()})}if(!this.timeout){q=function(){if(o()-p.lastHumanNav>2000){p.next()}return p.timeout=setTimeout(q,p.duration)};this.timeout=setTimeout(q,this.duration)}return this};m.prototype._unbind=function(){if(this.node){this.node.find(".prevSlide, .nextSlide, .slide-pager a, .options a").unbind("click")}if(this.timeout){clearTimeout(this.timeout);return this.timeout=null}};return m})();l=(function(n){b(m,n);function m(){return m.__super__.constructor.apply(this,arguments)}m.prototype.transitionFunction=f.clock;m.prototype.transitionDuration=1500;m.prototype.tmpl=c;m.prototype._sync=function(){var o;o=this.renderMode;m.__super__._sync.apply(this,arguments);return this.setRenderMode(o)};m.prototype.start=function(){var o=this;this.notCanvas=this.node.find(".slide-images:not(canvas) img");this.canvas=this.node.find("canvas.slide-images");if(this.canvas[0]&&this.canvas[0].getContext){this.ctx=this.canvas[0].getContext("2d")}if(this.photos){this.images=$.map(this.photos,(function(q){var p;p=new Image();p.src=q.src;return p}))}return m.__super__.start.apply(this,arguments)};m.prototype.setSize=function(o,p){m.__super__.setSize.call(this,o,p);if(this.canvas){this.canvas.attr("height",p).attr("width",o)}return this};m.prototype.setRenderMode=function(o){this.renderMode=o;if(this.ctx){if(this.renderMode==="canvas"){this.drawImage(this.images[this.current]);this.notCanvas.hide();this.canvas.show()}else{this.canvas.hide();this.notCanvas.show()}}return this};m.prototype.setTransition=function(o){this.setRenderMode("css");m.__super__.setTransition.call(this,o);return this};m.prototype.setTransitionFunction=function(o){this.transitionFunction=o;this.setRenderMode("canvas");return this};m.prototype.setTransitionDuration=function(o){this.transitionDuration=o;this.setRenderMode("canvas");return this};m.prototype.slide=function(o){this.fromSlide=this.current;this.toSlide=o;this.transitionStart=a();if(this.ctx&&this.renderMode==="canvas"){this.startRender()}return m.__super__.slide.call(this,o)};m.prototype.clean=function(){return this.ctx.clearRect(0,0,this.canvas[0].width,this.canvas[0].height)};m.prototype.drawImage=function(p){var o,q,r;r=this.canvas[0],q=r.width,o=r.height;return this.ctx.drawImage(p,0,0,q,q*p.height/p.width)};m.prototype._renderId=0;m.prototype.startRender=function(){if(this.transitionFunction.init){this.tfdata=this.transitionFunction.init(this,this.fromSlide,this.toSlide)}return this.render(++this._renderId,this.transitionFunction)};m.prototype.render=function(s,q){var p,o,r=this;p=a();if(s===this._renderId&&p>=this.transitionStart){o=Math.min(1,(p-this.transitionStart)/this.transitionDuration);if(o===1){this.clean();return this.drawImage(this.images[this.toSlide])}else{q.render(this,this.fromSlide,this.toSlide,o,this.tfdata);return i((function(){return r.render(s,q)}),this.canvas[0])}}};return m})(d);window.Slider=l;window.SliderTransitionFunctions=f;window.SliderUtils=e}).call(this);